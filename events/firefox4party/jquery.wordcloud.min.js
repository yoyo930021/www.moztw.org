(function(e){Array.prototype.shuffle=function(){for(var c,a,e=this.length;e;c=parseInt(Math.random()*e),a=this[--e],this[e]=this[c],this[c]=a);return this};e.wordCloudSupported=function(){var c=e("<canvas />");if(!c[0]||!c[0].getContext)return!1;c=c[0].getContext("2d");if(!c.getImageData)return!1;if(!c.fillText)return!1;if(!Array.prototype.some)return!1;if(!Array.prototype.push)return!1;return!0}();e.fn.wordCloud=function(c){if(!e.wordCloudSupported)return this;var a={fontFamily:'"Trebuchet MS", "Heiti TC", "\u5fae\u8edf\u6b63\u9ed1\u9ad4", "Arial Unicode MS", "Droid Fallback Sans", sans-serif',
gridSize:8,ellipticity:0.65,center:!1,drawMask:!1,maskColor:"rgba(255,0,0,0.3)",maskGridWidth:0.3,wordColor:"random-dark",backgroundColor:"#fff",wait:0,abortThreshold:0,abort:e.noop,weightFactor:1,minSize:4.5,wordList:[],rotateRatio:0.1,clearCanvas:!0};c&&e.extend(a,c);if(typeof a.weightFactor!=="function"){var C=a.weightFactor;a.weightFactor=function(a){return a*C}}a.gridSize=Math.max(a.gridSize,4);var b=a.gridSize,h,x,l,m,t,w,y,u,D=function(){var a=document.createElement("canvas").getContext("2d");
a.font="0px sans-serif";return Math.max(a.measureText("\uff37").width,a.measureText("m").width)>2}(),z=function(b,h,i,e,f){switch(a.wordColor){case "random-dark":return"rgb("+Math.floor(Math.random()*128).toString(10)+","+Math.floor(Math.random()*128).toString(10)+","+Math.floor(Math.random()*128).toString(10)+")";case "random-light":return"rgb("+Math.floor(Math.random()*128+128).toString(10)+","+Math.floor(Math.random()*128+128).toString(10)+","+Math.floor(Math.random()*128+128).toString(10)+")";
default:return typeof a.wordColor!=="function"?a.wordColor:a.wordColor(b,h,i,e,f)}},A=function(){return a.abortThreshold>0&&(new Date).getTime()-y>a.abortThreshold},B=function(d,e,i,c){var f=i,l;if(a.drawMask)h.fillStyle=a.maskColor;var j=h.getImageData(d*b,e*b,i*b,c*b);a:for(;f--;)for(l=c;l--;){var g;b:{g=j;var k=f*b,m=l*b,v=i*b,n=b,o=void 0;if(isNaN(t))for(var p=void 0;n--;)for(o=b;o--;)for(p=4;p--;){if(g.data[((m+o)*v+k+n)*4+p]!==w[p]){g=!1;break b}}else for(;n--;)for(o=b;o--;)if(g.data[((m+o)*
v+k+n)*4+t]!==w[t]){g=!1;break b}g=!0}g||(x[d+f][e+l]=!1,a.drawMask&&h.fillRect((d+f)*b,(e+l)*b,b-a.maskGridWidth,b-a.maskGridWidth));if(A())break a}},E=function(d,e){var i,c,f=1,t=Math.random()<a.rotateRatio,j=a.weightFactor(e);if(D&&j<17||j<4.5)f=Math.ceil(17/j);if(j<=a.minSize)return!1;h.font=(j*f).toString(10)+"px "+a.fontFamily;if(t){var g=h.measureText(d).width/f,k=Math.max(j*f,h.measureText("m").width,h.measureText("\uff37").width)/f;/[Jgpqy]/.test(d)&&(k*=1.5);k+=Math.floor(j/6);g+=Math.floor(j/
6)}else k=h.measureText(d).width/f,g=Math.max(j*f,h.measureText("m").width,h.measureText("\uff37").width)/f,/[Jgpqy]/.test(d)&&(g*=1.5),g+=Math.floor(j/6),k+=Math.floor(j/6);k=Math.ceil(k);g=Math.ceil(g);i=Math.ceil(k/b);c=Math.ceil(g/b);var w=a.center?[a.center[0]/b,a.center[1]/b]:[l/2,m/2],v=Math.floor(Math.sqrt(l*l+m*m)),n=l+m,o,p,u;for(o=v;o--;){p=n;for(u=[];p--;)u.push([Math.floor(w[0]+(v-o)*Math.cos(-p/n*2*Math.PI)-i/2),Math.floor(w[1]+(v-o)*a.ellipticity*Math.sin(-p/n*2*Math.PI)-c/2),p/n*2*
Math.PI]);if(u.shuffle().some(function(r){var q;a:{q=r[0];var s=r[1];if(q<0||s<0||q+i>l||s+c>m)q=!1;else{for(var p=i,n;p--;)for(n=c;n--;)if(!x[q+p][s+n]){q=!1;break a}q=!0}}if(q)return f!==1||t?(q=document.createElement("canvas"),q.setAttribute("width",k*f),q.setAttribute("height",g*f),s=q.getContext("2d"),s.fillStyle=a.backgroundColor,s.fillRect(0,0,k*f,g*f),s.fillStyle=z(d,e,j,v-o,r[2]),s.font=(j*f).toString(10)+"px "+a.fontFamily,s.textBaseline="top",t&&(s.translate(0,g*f),s.rotate(-Math.PI/2)),
s.fillText(d,Math.floor(j*f/6),0),h.clearRect(Math.floor(r[0]*b+(i*b-k)/2),Math.floor(r[1]*b+(c*b-g)/2),k,g),h.drawImage(q,Math.floor(r[0]*b+(i*b-k)/2),Math.floor(r[1]*b+(c*b-g)/2),k,g)):(h.font=j.toString(10)+"px "+a.fontFamily,h.fillStyle=z(d,e,j,v-o,r[2]),h.fillText(d,r[0]*b+(i*b-k)/2,r[1]*b+(c*b-g)/2)),B(r[0],r[1],i,c),!0;return!1}))return!0}return!1};return this.each(function(){if(this.nodeName.toLowerCase()==="canvas"){l=Math.floor(e(this).attr("width")/b);m=Math.floor(e(this).attr("height")/
b);h=this.getContext("2d");x=[];var d=document.createElement("canvas").getContext("2d");d.fillStyle=a.backgroundColor;d.clearRect(0,0,1,1);d.fillStyle=a.backgroundColor;d.fillRect(0,0,1,1);w=d.getImageData(0,0,1,1).data;if(typeof a.wordColor!=="function"&&a.wordColor.substr(0,6)!=="random"){d.fillStyle=a.wordColor;d.fillRect(0,0,1,1);for(var d=d.getImageData(0,0,1,1).data,c=4;c--;)if(Math.abs(d[c]-w[c])>10){t=c;break}}else t=NaN;for(var d=l,i;d--;){x[d]=[];for(i=m;i--;)x[d][i]=!0}a.clearCanvas?(h.fillStyle=
a.backgroundColor,h.clearRect(0,0,l*(b+1),m*(b+1)),h.fillRect(0,0,l*(b+1),m*(b+1))):B(0,0,l,m);h.textBaseline="top";clearTimeout(e(this).data("wordCloud-timer"));c=0;u=setInterval(function(){c>=a.wordList.length?clearTimeout(u):(y=(new Date).getTime(),E(a.wordList[c][0],a.wordList[c][1]),A()&&(clearTimeout(u),a.abort()),c++)},a.wait);e(this).data("wordCloud-timer",u)}})}})(jQuery);

